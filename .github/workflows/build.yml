name: Build Quad-Blend Drive

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    name: Build on macOS
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Verify VST3 build
      run: |
        if [ ! -d "build/Source/QuadBlendDrive_artefacts/Release/VST3/Quad-Blend Drive.vst3" ]; then
          echo "VST3 build failed"
          exit 1
        fi
        echo "VST3 built successfully"

    - name: Verify AU build
      run: |
        if [ ! -d "build/Source/QuadBlendDrive_artefacts/Release/AU/Quad-Blend Drive.component" ]; then
          echo "AU build failed"
          exit 1
        fi
        echo "AU built successfully"

    - name: Package artifacts
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        mkdir -p artifacts
        cp -r "build/Source/QuadBlendDrive_artefacts/Release/VST3/Quad-Blend Drive.vst3" artifacts/
        cp -r "build/Source/QuadBlendDrive_artefacts/Release/AU/Quad-Blend Drive.component" artifacts/
        cd artifacts
        zip -r QuadDrive-macOS.zip "Quad-Blend Drive.vst3" "Quad-Blend Drive.component"

    - name: Upload artifacts
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: QuadDrive-macOS
        path: artifacts/QuadDrive-macOS.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/QuadDrive-macOS.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
